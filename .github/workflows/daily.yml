name: Daily Tasks

on:
  schedule:
    # Runs at 10:30 am UTC+8 every day
    - cron: "30 2 * * *"
  workflow_dispatch:

jobs:
  run-tasks:
    name: Run FF14 Risingstone Tasks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      # 1. 运行原版 Docker 容器，执行签到任务
      - name: Run Sign-in Task
        uses: docker://ghcr.io/starhearthunt/ff14risingstone_sign_task:master
        with:
          cookie: ${{ secrets.COOKIE }}
          user_agent: ${{ secrets.USER_AGENT }}
        id: sign_in # 给这个步骤一个 ID，方便后续引用它的输出
      
      # 2. 准备 Python 环境，用于发送推送
      - name: Set up Python for PushPlus
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 
      - run: pip install requests # 安装发送请求的库
      
      # 3. 发送 PushPlus 通知
      - name: Send PushPlus Notification
        if: always() # 仅使用 always() 确保无论前一步成功或失败都执行
        env:
          PUSH_PLUS_TOKEN: ${{ secrets.PUSH_PLUS_TOKEN }}
        run: |
          # **【关键修正】**：在 Shell 脚本中检查 Token 是否存在
          if [ -z "$PUSH_PLUS_TOKEN" ]; then
            echo "未配置 PUSH_PLUS_TOKEN，跳过推送。"
            exit 0
          fi
          
          LOG_TITLE="FF14签到任务完成"
          
          # job.status 是一个上下文变量，可以直接在 run: 脚本中使用
          if [[ "${{ job.status }}" == "success" ]]; then
            LOG_TITLE="✅ FF14签到任务成功完成"
            MESSAGE="今日签到已执行，任务状态正常。请查看工作流日志确认奖励领取情况。"
          else
            LOG_TITLE="❌ FF14签到任务失败或Cookie已过期"
            MESSAGE="签到工作流运行失败！请检查 GitHub Actions 日志和你的 Cookie 是否过期。"
          fi

          # Python 命令发送推送
          python - <<EOF
          import requests
          import os
          
          token = os.environ.get('PUSH_PLUS_TOKEN')
          url = 'http://www.pushplus.plus/send'
          data = {
              "token": token,
              "title": "$LOG_TITLE",
              "content": "$MESSAGE",
              "template": "html"
          }
          try:
              requests.post(url, json=data)
              print("PushPlus 推送成功发送。")
          except Exception as e:
              print(f"PushPlus 推送失败: {e}")
          EOF
